---
title: "R Notebook"
---

```{r}
library(tidyverse)

n_timepoints <- 10
n_sites <- 10
subjects_per_site <- 100
n_samples <- 10

stable_site_variance <- 1
baseline_site_variance <- 1
intervention_site_variance <- 1
condition_mean_diff <- .20
random_error <- 1

parallel_design <- matrix(nrow = n_sites, ncol = n_timepoints)
parallel_design[seq(1, round(n_sites/2)), ] <- 0
parallel_design[is.na(parallel_design)] <- 1

stepped_wedge <- matrix(nrow = n_sites, ncol = n_timepoints)
stepped_wedge[lower.tri(stepped_wedge)] <- 0
stepped_wedge[is.na(stepped_wedge)] <- 1
```

```{r}
design_to_dataframe <- function(design_matrix, design){
  design_matrix |> 
    as.data.frame() |> 
    pivot_longer(
      cols = everything(), 
      names_to = "time",
      names_pattern = "V(.)",
      names_transform = as.numeric,
      values_to = "condition") |> 
    mutate(
      design = design,
      site = row_number()) |> 
    select(design, site, time, condition)
}
```

```{r}
design_df <- bind_rows(
  design_to_dataframe(parallel_design, "parallel"),
  design_to_dataframe(stepped_wedge, "rollout"))
```

```{r}
sample_df <- design_df |> 
  expand_grid(sample_id = seq(n_samples), subject_id = seq(subjects_per_site)) |>
  group_by(sample_id, design) |> 
  mutate(subject_id = row_number()) |> # make subjects unique in a sample/design
  ungroup() |> 
  select(sample_id, everything()) |> 
  arrange(sample_id, design, site, time, condition, subject_id)
```

```{r}
sample_df <- sample_df |> 
  group_by(sample_id, site) |> 
  mutate(stable_site_intercept = rnorm(n = 1, sd = sqrt(stable_site_variance))) |> 
  ungroup()

sample_df
```

```{r}
sample_df <- sample_df |> 
  group_by(sample_id, site) |> 
  mutate(
    condition_site_intercept = case_when(
      condition == 0 ~ rnorm(n = 1, sd = sqrt(baseline_site_variance)),
      condition == 1 ~ rnorm(n = 1, sd = sqrt(intervention_site_variance)))) |> 
  ungroup()
```

```{r}
sample_df <- sample_df |> 
  mutate(
    condition_effect = case_when(
      condition == 0 ~ 0,
      condition == 1 ~ condition_mean_diff))
```

```{r}
sample_df <- sample_df |> 
  group_by(sample_id, subject_id, time) |> 
  mutate(random_error = rnorm(n = 1, sd = sqrt(random_error))) |> 
  ungroup()
```

```{r}
sample_df <- sample_df |> 
  mutate(
    outcome = condition_effect + # condition_site_intercept + 
      stable_site_intercept + random_error)
```


```{r}
library(future.apply)

plan(multisession)

model_df <- sample_df |> 
  group_by(sample_id, design) |> 
  nest() |>
  ungroup()

model_fits <- future_lapply(
  X = model_df |> 
    pull(data),
  FUN = function(sample_data) 
    lmerTest::lmer(outcome ~ condition + (1 | site), data = sample_data))

model_df <- model_df |> 
  mutate(
    fit = model_fits,
    statistics = map(fit, broom.mixed::tidy))
```

```{r}
results_df <- model_df |> 
  select(sample_id, design, statistics) |> 
  unnest(statistics)
  
power_df <- results_df |> 
  filter(term == "condition") |> 
  mutate(bias = estimate - condition_mean_diff) |> 
  group_by(design) |> 
  summarise(
    n_samples = n(),
    bias = mean(bias),
    power = mean(p.value < .05))

power_df
```

```{r}
results_df |> 
  
```


