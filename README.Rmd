---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# rollout

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/rollout)](https://CRAN.R-project.org/package=rollout)
[![R-CMD-check](https://github.com/iancero/rollout/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/iancero/rollout/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/iancero/rollout/branch/main/graph/badge.svg)](https://app.codecov.io/gh/iancero/rollout?branch=main)
<!-- badges: end -->

A **rollout trial** involves "rolling out" an intervention across different sites or groups in incremental phases. There are many kinds of rollout trials (e.g., stepped-wedge, head-to-head, single-arm). The **rollout package** simulates and evaluates statistical properties (e.g., power) of a rollout study designs.

## Installation

You can install the development version of rollout like so:

```{r, eval = FALSE}
devtools::install_github("iancero/rollout")
```

## Workflow

Evaluating the power of a rollout design involves: 

1. Specifying the rollout schedule and expected intervention effects
2. Simulating several datasets
3. Fitting a statistical model to each dataset
4. Evaluating the statistical properties (e.g., power) of those fitted models

The rollout package provides functions to help you with each of these steps.

## Specifying rollout schedules and effects

In this step, we specify the rollout schedule and expected effects of the intervention. For example, we might specify that the intervention will be rolled out in three phases, each lasting a different amount of time.^[Note, the rollout package measures time in discrete steps, like days, months, or years. However, it is agnostic to units, so phases all need to be specified on the same time scale (e.g., if `baseline = 3` signifies "3 months" in your design, rollout will then assume `intervention = 2` is also in months). Lastly, the package does not (yet) support continuous time.] 

- A three month **baseline phase**, in which no intervention is applied, but data from each participating cohort are collected.
- An two month **intervention phase**, in which each cohort receives the intervention
- A four month **sustainment phase**, in which the intervention is no longer applied, but data are still collected to evaluate whether the effects of the intervention persist beyond its initial application.

Specifying the **rollout schedule** in the rollout package is done by creating a named list of rollout **phase durations**. The names of the list elements correspond to the names of the phases, and the values correspond to the duration of each phase in time steps. For example, the rollout schedule described above would be specified as follows:

```{r}
library(rollout)

phase_durations <- list(baseline = 3, intervention = 2, sustainment = 4)
```

**Phase effects** are specified in a similar way. For example, we might specify that the intervention has no effect during the baseline phase, a positive effect during the intervention phase, and a smaller positive effect during the sustainment phase. 

```{r}
phase_effects <- list(baseline = 0, intervention = 2, sustainment = 1)
```

## Simulating rollout sample data

Before generating rollout sample data, we need to specify a few more simulation parameters. For example, we might specify that our design is rolled out across 12 cohorts, each with 100 subjects.

```{r}
n_cohorts <- 12
subjects_per_cohort <- 100
```

Then, all of our these specifications are then combined into a named list that is passed to the `simulate_rollout_samples()` function.

```{r}
sim_params <- list(
  phase_durations = phase_durations,
  phase_effects = phase_effects,
  n_cohorts = n_cohorts,
  subjects_per_cohort = subjects_per_cohort
)
```

Finally, we simulate several datasets consistent with the rollout schedule and expected effects. The `simulate_rollout_samples()` function generates a dataset with the specified number of cohorts and subjects per cohort, and adds columns for the phase, time, and outcome variables. The outcome variable is generated by summing the effects of the phase, time, and random error terms.

```{r, eval=FALSE}
simulated_samples_df <- simulate_rollout_samples(sim_params, n = 100)
```

## Fitting a statistical model

Next, we fit a statistical model to each simulated dataset. The `fit_model()` function fits a linear mixed-effects model to each dataset. The model includes fixed effects for the phase, time, and cohort, and random effects for the cohort and subject.

```{r, eval=FALSE}
model <- "outcome ~ phase + time + (1 | cohort) + (1 | subject)"
fitted_models <- fit_model(simulated_samples_df, model)
```

## Evaluating design properties

Finally, we evaluate the statistical properties of the fitted models. The `eval_design()` function calculates a range of useful statistics, including the power and bias of the estimated intervention effect for each phase.

```{r, eval=FALSE}
eval_design(fitted_models, feature = c("power", "bias"))
```

# Advanced features

The rollout package includes a number of advanced features to help you simulate and evaluate rollout designs.

## Complex phase schedules

## Custom phase effects

## Visualization

## Pipe-friendly

The rollout package is designed to be pipe-friendly, so you can easily chain together multiple functions to simulate and evaluate rollout designs. The entire workflow can be written in a single pipe, like this:

```{r, eval=FALSE}
results <- sim_params |> 
  sim_samples(n = 100) |> 
  fit_models(model) |> 
  eval_design(feature = c("power", "bias"))
```

# Performance

Rollout trials are typically quite large, meaning simulations of rollout trials are even larger. The rollout package is therefore equipped with a range of features to speed up computation.

## Parallel processing

The rollout package supports parallel processing, which can significantly speed up simulations of large rollout trials. By default, the package uses the `future` package to run simulations in parallel. You can control the number of cores used for parallel processing by setting the `future::plan()` options.

```{r, eval=FALSE}
future::plan(future::multisession, workers = 4)

results <- sim_params |> 
  sim_samples(n = 100) |> 
  fit_models(model) |> 
  eval_design(feature = c("power", "bias"))
```

## Threshold inferences

Although final inferences should be based on the full set of simulations, the study design process is typically iterative and exploratory. The rollout package supports "threshold inferences," which can speed up simulations by stopping the simulation process early, if a given design statistic (e.g., power) has crossed a particilar threshold.

```{r, eval=FALSE}
results <- sim_params |> 
  sim_samples(n = 100) |> 
  fit_models(model) |> 
  eval_design(
    feature = c("power", "bias"), 
    threshold = list(power = 0.8, p = 0.05))
```






